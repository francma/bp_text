\chapter{GitLab CI}

GitLab CI je součástí součástí správce GIT repozitářů GitLab.
Jeho použití je tedy vymezeno pouze pro uživatele tohoto systému.
Projekt je vydáván pod několika edicemi -- komerční a komunitní, která je vydána pod open source licencí \cite{gitlab_ce}.

\section{Průběh integrace}

Konfigurace integrace je řešena pomocí souboru \verb|.gitlab-ci.yml|, který je umístěn přímo v~kořenovém adresáři repozitáři projektu.
Konfigurace projektu je dostupná přes webové UI nebo jiné rozhraní využívající dostupné API.

Proces integrace je rozdělen na fáze (\textit{stages}), úkoly (\textit{jobs}) a příkazy.
Fáze se vykonávají sekvenčně za sebou v~zadaném pořadí.
Pokud jedna z~fází selže, tak celý proces integrace končí chybou.

\begin{listing}[ht]
\begin{minted}[frame=single,linenos]{yaml}
stages:
  - test
  - build
  - deploy
\end{minted}
\caption{Definice fázi v .gitlab-ci.yml}
\end{listing}

Jednotlivé fáze se skládají z~několika úkolů.
Ůkoly v rámci fáze jsou spouštěny nezávisle na sobě a tím pádem je lze paralelizovat.
Selhání jednoho z~úkolů vede k~neuspěchu celé fáze.
Úkoly jsou vždy provedeny všechny, nezávisle na výsledku ostatních v~rámci fáze.

\begin{listing}[ht]
\begin{minted}[frame=single,linenos]{yaml}
job1:
  stage: test
  script:
    - cmd 1
    - cmd 2
\end{minted}
\caption{Definice úkolu job1 v .gitlab-ci.yml}
\end{listing}

Každý úkol je složen z~několika příkazů.
Pokud jeden z~příkazů skončí chybovým návratovým kódem, pak je ukončeno provádění úkolu.

Mezi speciální úkoly patří \verb|before_script| a \verb|after_script|.
Tyto úkoly jsou provedeny vždy před nebo po každým uživatelsky definovaným úkolem.

\begin{listing}[ht]
\begin{minted}[frame=single,linenos]{yaml}
before_script:
  - cmd 1
  - cmd 2

after_script:
  - cmd 1
  - cmd 2
\end{minted}
\caption{Definice before\_script a after\_script .gitlab-ci.yml}
\end{listing}

Jednotlivým úkolům lze přiřadit podmínečné spuštění pomocí notace \verb|when|.

\begin{itemize}
  \item \verb|on_success| -- vykonej pouze pokud předchozí fáze skončila úspěchem (výchozí) 
  \item \verb|on_failure| -- vykonej pouze pokud předchozí fáze skončila neúspěchem
  \item \verb|always| -- vykonej vždy
\end{itemize}

\section{Architektura}

Celý systém GitLabu je rozdělen do několika podsystémů, které mezi sebou komunikují převážně protokolem gRPC.
Gitlab CI Runner je zodpovědný za provedení konkrétnách integrací.
Využívá se i message-based systému pro přenos zpráv.
Dalším službám systém poskytuje REST API s přípravou GraphQL API.
\cite{gitlab_architecture}
\cite{gitlab_api}

Persistetním uložištěm je databáze, konkrétně PostgreSQL.
Pro dočasná data a zprávy přenášené pomocí message-based protokolu se používá paměťová struktura v RAM Redis.

\subsection{Gitlab CI multi-runner}

CI systém spolupracuje s~několika běhovými servery (\textit{Runners}), které se starají o~samotné vykonání integrace.
Běhový server je schopen provozovat paralelně několik běhových prostředí různého typu.
Volba běhováho serveru je definována na úrovni konfigurace projektu a je omezena globálním nastavením Gitlab CI.

% https://docs.gitlab.com/ee/ci/runners/README.html
% http://docs.gitlab.com/ce/api/ci/builds.html

\subsubsection{Shell běhové prostředí}

Příkazy provádí na stejném systému pod stejným uživatelem jako samotný běhový server.
Z tohoto plyne mnoho bezpečnostních rizik a proto se použití tohoto běhového prostředí doporučuje pouze pro testování.

\subsubsection{Docker běhové prostředí}

Příkazy se provádí uvnitř Dcoker kontejneru.
Volba Docker obrazu definována klíčovým slovem \verb|image|.
Sestavení lze obohatit o~tzv. služby, kterými můžeme každému buildu dát k~dispozici přístup k~další Docker instanci, která bude dostupná pod zadanou hostname.
Služby lze opět konfigurovat na úrovni sestavení, tak na úrovni jobu.

\begin{minted}[frame=single,linenos]{yaml}
image: ruby:2.2

services:
  - postgres:9.3

test:
  script:
  - bundle exec rake spec
\end{minted}

\subsubsection{VirtualBox a Parallels}

Virtualizační technologie.
Virtualní stroj musí podporovat Bash kompatibilní shell a být dostupný přes SSH spojení.
Virtualní stroje jsou klonovány pro udržení čistého prostředí pro sestavení a snapshotovány pro urychlení dalších sestavení.

% https://docs.gitlab.com/runner/executors/README.html

\subsubsection{SSH exekutor}

Podobné jako Shell exekutor, jen je využito SSH spojení.

\subsection{Cachování}

Ve výchozím stavu je cache sdílena mezi \textit{branch} a \textit{job}.
Toto chování lze upravit nastavením klíče, který bude identifikovat danou cache.
Při tvorbě klíče lze využít předdefinované CI proměnné. 
Soubory a složky určené k~cachování uvedeme jako výčet v~konfiguraci projektu.
Cesta k~souboru je uvedená jako relativní ke kořeni projektu, cachování souborů mimo projekt není touto cestou možné. 
Cache lze také omezit pouze na soubory a složky, které nejsou verzovany GITem.

\begin{minted}[frame=single,linenos]{yaml}
cache:
  key: "$CI_BUILD_NAME/$CI_BUILD_REF_NAME"
  untracked: true
  paths:
    - binaries/
    - .config
\end{minted}
 
Cache je ve výchozím nastavení ukládána přímo na běhovém serveru.
Pokud fáze běží na různých běhových serverech, tak se cache nesdílí.
Alternativně můžeme použít sdílené cachování na S3 kompatibilních serverech.
S3 je REST API, které bylo původně vytvořeno jako část Amazon services.
Toto API implementuje samotný Amazon, tak i nějaké self-hosted projekty.

% https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/merge_requests/88
% https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html
% https://github.com/minio/minio/



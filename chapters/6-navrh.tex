\chapter{Návrh systému}

V této kapitole se budeme věnovat návrhu systému.
V následujícím textu bude odkazováno na navrhovaný systém jeho vybraným názvem -- Piper~CI.
Inspirací pro jméno je firma Pied Piper z TV seriálu Sillicon Valley \cite{pied_piper}.

\section{Průběh integrace}

Integrační proces bude rozdělen na fáze, úkoly a příkazy.
Integrační proces se skládá alespoň z jedné fáze.
Fáze se skládá z jednoho nebo více úkolů.
Ůkol v sobě obsahuje jeden nebo více příkazů.

Selhání jednoho z příkazů vede k ukončení vykonávání úkolu a jeho selhání.
Jelikož jsou úkoly prováděny nezávisle na sobě, tak po selhnáhí jednoho úkolu jsou ostatní úkolu v rámci fáze dokončeny.
Pokud jeden z úkolů v rámci fáze selže, tak selže celá fáze a další fáze už nejsou prováděny.
Fáze jsou prováděny sekvenčně.

Integrační proces je pokládán za úspešný poté, co jsou všechny jeho fáze v úspěšném stavu.

Jednotlivé úkoly, fáze nebo celé integrace je možné restartovat nebo rušit.

\section{Architektura}

Při výběru architektury systému by měl být brán v potaz požadavek na jeho modulárnost.
Modularity systému docílíme výběrem vhodné architektury.

\subsection{REST}

REST je architektonický vzor splňující následující požadavky:

\begin{itemize}
    \item model klient-server,
    \item bezstavový model,
    \item správa mezipaměťi,
    \item uniformní rozhraní,
    \item vrstvená architektura. \cite{rest}
\end{itemize}

\subsubsection{Model klient-server}

Model klient-server je styl návhru systému, který dělí jeho části na poskytovatele služeb (servery) a jejich uživatele (klienty).
Rozdělením systému na více (na sobě nezávislých) částí je docíleno vylepšené portabtability a škálovatelnosti.
\cite{rest_klient_server}

\subsubsection{Bezstavový model}

Bezstavové odbavení požadavku znamená, že každý požadavek musí obsahovat všechny informace k jeho vyřízení.
Přínosem je jednodušší odbavení požadavku z hlediska serveru, který nemusí udržovat jednotlivým klientům jejich stav (\textit{session}) nebo řešit chyby na základě nevalidního stavu.
Nevýhoda spočívá v redundanci přenesených dat.
\cite{rest_bezstavovy}

\subsubsection{Správa mezipaměti}

Součástí odpovědi od serveru může být i informace o tom, zda je možné tuto odpověď znovupoužít.
Klient pak místo posílání dalšího stejného požadavku může použít již obdrženou odpověď z mezipaměti.
Výhodou je uvolnění systémových prostředků serveru.
Na druhé straně se může stát, že odpověd v mezipaměti je již neplatná.
\cite{rest_mezipamet}

\subsubsection{Uniformní rozhraní}

Rozhraní serveru je navrženo obecně, bez přizpůsobení požadavkům jednoho určitého klienta.
Tímto je dosaženo zjednodušení serverové části za cenu snížení efektivity.
\cite{rest_uniformni}

\subsubsection{Vrstvená architektura}

Příjemce požadavku a jeho vykonavatel nemusí být tentýž server.
Z hlediska klienta se v komunikaci se serverem nic nemění.
Nevýhodou je zvýšení režie a latence přenosu dat.
Přínos spočívá v umožnění rozdělení serverové části na více menších systémů, které jsou snažší na správu a umožňují lepší škálovatelnost.
\cite{rest_architektura}

\subsubsection{Reprezentace dat a přístup ke zdrojům}

Základním stavebním kamenem REST rozhraní jsou zdroje.
Každá pojmenovatelná informace může být zdrojem (např. počasí dnes v Praze, \ldots), kolekce dalších zdrojů (např. počasí v hlavních městech Evropy) a další.
Zdroj je identifikován URI adresou.
\cite{rest_zdroje}

\section{Struktura systému}

V případě Piper CI je poskytovatelem služeb jádro systému (Piper CI core), které přes API poskytuje přístupy ke svým zdrojům.
API je zpřístupněno pomocí webového serveru dle výběru provozovatele.
Webové rozhraní se chová jako prostředník mezi klientem (webovým prohlížečem) a poskytovatelem služeb (tento přístup je definován v REST jako vrstvená architektura).
Terminálový klient komunikuje s jádrem systému přímo přes SSH protokol.
Grafická reprezentace systému je vyobrazena v diagramu \ref{pic:architektura_piper.pdf}.

\imagefigurelarge{architektura_piper.pdf}{Návrh architektury Piper}

Poté, co je integrace rozdělena na jednotlivé úkoly, je jádro zařadí do fronty, odkud jsou vyzvednuty běhovými klienty a zpracovány.
Běhový klient informuje průběžně jádro systému o průběhy integrace (stav a log výstup).
Jádro systému tyto informace zpracovává a archivuje.

\section{Model jádra systému}

Model jádra systému je rozdělen do entit, které mají mezi sebou vazby.
Vše začíná u projektu, který je vazbou mezi systémem CI a verzovacím systémem.
Klient komunikuje se systémem s určitou identitou, reprezentovanou uživatelskou entitou.
Uživatelé jsou přiřazování do projektů.
K projektu jsou vázány data o jeho provedených integracích.
Běhovým klientům jsou přiřazovány úkoly, které vykonávájí.
Grafická reprezentace entit v systému je vyobrazena na obrázku \ref{pic:entity_piper.pdf}.

\imagefigurelarge{entity_piper.pdf}{Entity v Piper CI}

\section{Návrh API}

REST API jádra je dostupné přes HTTP protokol.
Definice REST zdrojů vychází z definice entit systému.

\verb|/projects| -- projekty,
\verb|/builds| -- integrace,
\verb|/stages| -- fáze,
\verb|/jobs| -- úkoly,
\verb|/runners| -- běhový klienti,
\verb|/users| -- uživatelé.

Filtrace dat poskytovanými zdroji je implementována skládáním zdrojů do sebe, například \verb|/projects/1/builds| vrací integrace pro projekt s identifikátorem 1.
Další filtrace zdrojů jsou dostupné přes HTTP query parametry, například \verb|/projects?origin=git@gitlab.com| vratí projekty s daným originem.
Speciálním případěm filtrace jsou HTTP query parametry \verb|limit| a \verb|offset|, pomocí kterých lze implemetovat stránkování.

Akce nad zdroji je definována použitou HTTP metodou -- \verb|GET| (získej) \verb|POST| (vytvoř) \verb|PUT| (aktualizuj) \verb|DELETE| (smaž).
Výsledek akce je reprezentován návratovým HTTP kódem.

\section{Autentizace a autorizace}

Autentizace uživatele do systému je přes terminálové rozhraní je provedená přes SSH RSA klíče.
Každý uživatel má v systému zavedený svůj veřejný klíč.
Mimo veřejného klíče uživatel disponuje také tokenem, který je použit pro autentizaci se systémy třetí strany (webové rozhraní).

Oprávnění jsou definována na úrovni systému a jednotlivých projektů v podobě rolí.

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}

Systémové role jsou následující:

\paragraph{ROOT}

Administrátor celého systému.
Je autorizován ke všem akcím.
Podobnost s root oprávněním v Unixu.

\paragraph{ADMIN}

Administrátor na úrovni projektů.

\paragraph{NORMAL}

Obyčejný uživatel, který je zařazován do projektů.

\paragraph{GUEST}

Návštěvník.
Výchozí identita pro nepřihlášeného uživatele.

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}

Projektová role jsou následující:

\paragraph{MASTER}

Správce projektu.
Edituje projekt a přídává do něj uživatele.

\paragraph{DEVELOPER}

Člen projektu.

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}

\subsection{Uživatelé}

Uživatelé mají plná oprávnění v případě editace sama sebe.
Role ADMIN může vytvářet pouze uživatele s oprávněním NORMAL.

\begin{table}[h]
\centering
\caption{Oprávnění v uživatelskému modelu}
\begin{tabular}{|l|l|l|l|l|}
\hline
       & ROOT & ADMIN & NORMAL & GUEST \\ \hline
Zobrazení   & x    & x     &        &       \\ \hline
Vytvoření & x    & x     &        &       \\ \hline
Editace   & x    &       &        &       \\ \hline
Smazání & x    &       &        &       \\ \hline
\end{tabular}
\end{table}

\subsection{Běhoví klienti}

Přidání běhového klienta by měla být pouze záležitost hlavního administrátora systému (ROOT).
Naopak zobrazení běhových klientů by mělo být přístupné všem, protože v definici integrace je nutné uvest i běhového klienta.

\begin{table}[h]
\centering
\caption{Oprávnění v modulu běhových klientů}
\begin{tabular}{|l|l|l|l|l|}
\hline
       & ROOT & ADMIN & NORMAL & GUEST \\ \hline
Zobrazení   & x    & x     & x      &       \\ \hline
Vytvoření & x    &       &        &       \\ \hline
Editace   & x    &       &        &       \\ \hline
Smazání & x    &       &        &      \\ \hline
\end{tabular}
\end{table}

\subsection{Projektoví uživatelé}

Přidání a odebrání uživatelů do projektů je dovoleno pouze uživatelům, kteří mají v daném projektu roli ADMIN.
Uživatel je schopen odebrat sám sebe z projektu.

\subsection{Integrace}

Informace o integracích jsou veřejné pro všechny uživatelé, dokonce i v roli GUEST.
Restart nebo zrušení integrace je dovoleno pouze uživatelům v projektu.

\section{Návrh terminálového rozhraní}

\section{Komunikace v \uv{realném čase}}

Pro zaručení co největší uživatelské přívětivosti by bylo vhodné, aby webové rozhraní CI systému umělo zobrazit některé informace ihned jakmile budou dostupné, bez nutnosti manuálně vyvolat obnovení dat.
Server tedy posílá pouze žádané informace a ne celou webovou stránku.
Jedná se například o~stavy buildů nebo výpis výstupu aktuálně běžícího buildu (tzv. \uv{streaming logu}).
Klientem je v~této komunikaci webový prohlížeč a serverem CI systém.

Za opravdovou komunikaci v realném čase by se dalo považovat websocketové spojení \cite{websocket}.
Je třeba si ale uvědomit, že data systému není nutné poskytovat v opravdu realném čase a i několika sekundové zpoždění není na závadu.
Důvodem je to, že na stav integrace není nutné okamžitě reagovat, výstup z \uv{streaming logu} je pouze jednostanný, neumožňující uživatelskou interakci.

Jako nejvýhodnější řešení se jeví metoda pollingu.
Metoda pollingu spočívá v~opakovaném dotazování ze směru klienta (webového prohlížeče) směrem k~serveru (CI systém) v~určitém časovém intervalu.
Nevýhoda tkvý v~plýtvání systémových prostředků z~důvodu velkého počtu dotazů.
Výhodou je velmi jednoduchá implementace.

\begin{listing}[ht]
\begin{minted}[frame=single, linenos]{text}
00:00:00 Klient -> Máš pro mě něco?
00:00:01 Server -> Ne, čekej.
00:00:01 Klient -> Máš pro mě něco?
00:00:02 Server -> Ne, čekej.
00:00:02 Klient -> Máš pro mě něco?
00:00:03 Server -> Ano. Tady to je!
\end{minted}
\caption{Short polling}
\end{listing}

K~uskutečnění dotazu ze směru prohlížeče využijeme JavaScript a jeho třídu \verb|XMLHttpRequest| nebo Fetch API \cite{fetch_api}.
Z pohledu strany serveru se jedná o~klasický HTTP požadavek.

Přidání čekací smyčky na straně serveru místo odeslání okamžité odpovědi se nazývá long-polling.

Stále znovuotevírání HTTP spojení ze strany klienta k serveru můžeme vyřešit nasazením HTTP2, které po jednom spojení dokáže odeslat více požadavků.

\section{Komuninakce s~běhovým prostředím}

Cílem je vytvořit rozhraní s běhovým prostředím, které přijme zadaný příkaz nebo jejich sadu a poskytne přístup k průběžnému výstupu.
Pokud budeme vykonávat jednotlivé příkazy odděleně, tak je nutné zajistit persistenci prostředí uvnitř běhového prostředí.
Například pokud jeden příkaz nadefinuje proměnné prostředí, tak další příkaz by k nim měl mít přístup (například změna pracovní složky \verb|$PWD|).

\subsection{Virtualbox}

Jelikož se jedná o plnou virtualizaci, tak je potřeba vytvořit jakýsi můstek mezi hostem a hostitelem.

\subsubsection{COM port pro čtení/zápis}

Pomocí VirtualBox administračního rozhraní vytvoříme COM port, jehož výstup nasměrujeme do souboru nebo sockeru na hostitelském systému.
Každý spuštěný příkaz poté přesměrujeme na zvolený COM port a aplikace provozovaná na hostitelském systému tento výstup převezme.
Spojení je oboustranné, takže je možné předávat příkazy i do hostovaného systému.
\cite{virtualbox_serial}

\subsubsection{SSH spojení}

SSH je kryptografický protokol, který umožňuje oboustrannou komunikaci mezi účastníky \cite{ssh_rfc}.
Přihlášení uživatele do systému je implementováno na základě věřejného klíče, hesla, hostname nebo lze ověřování úplně vypnout \cite{ssh_auth_rfc}.
Pro naše účely lze ověřované úplně vypnout za předpokladu, že dokažeme ohlídat možné zneužití.

\subsection{Docker}

Příkazy lze předávat do kontejneru přímo z~hostujícího stroje.
Výstup z příkazů pak jednoduše směrujeme do souboru nebo socketu.

\begin{listing}[ht]
\begin{minted}[frame=single,linenos]{shell}
docker start [jmeno_kontejneru]
docker exec -i [jmeno_kontejneru] [prikaz] >> [soubor]
\end{minted}
\caption{Předání výstupu z Docker kontejneru}
\end{listing}

Pro využití přímo v našem programu můžeme využít jednu z mnoha SDK knihoven \cite{docker_sdk}.

\subsection{LXD}

Jádro LXD je proces běžící na pozadí, který zpřístupňuje svoji funkcionalitu skrze REST API dostupné přes lokální unix socket nebo síť \cite{lxd}.
Klientem může být naše vlastní implementace podle REST API specifikace nebo využijeme předpřipravené klienty \cite{lxd_rest}.

\begin{listing}[ht]
\begin{minted}[frame=single,linenos]{shell}
curl -k -L --cert cert --key key "https://localhost:8443/1.0/images"
\end{minted}
\caption{Dotaz na REST API pomocí HTTP}
\end{listing}

\section{Konfigurace integrací projektu}

Konfigurace integrací projektu je brána z textového souboru umístěného přímo v repozitáři projektu.
Velkou výhodou tohoto přístupu je, že v kombinaci s verzovacím systémem se konfigurace integrace váže vždy k určitému stavu repozitáře.

\subsection{Formát souboru}

První je nutné rozhodnout formát tohoto souboru.
Soubor může být pouhým strukturovaným popisem dat (JSON, YAML, XML, \ldots) nebo dokonce jednoduchý skript (Lua, Python, \ldots).
Jelikož cílem práce je systém minimalistický, tak se jeví jako vhodnější řešení definice integrace pomocí strukturovaného popisu dat.
Mezi uvažované formáty patří JSON, YAML a XML.
JSON není vhodný, kvůli absenci komentářů.
Ač XML formát komentáře podporuje, tak je pro člověka hůže čitelný a méně konfortní na editaci viz. ukázky \ref{listing:xml} a \ref{listing:yaml}.

\begin{listing}[ht]
\begin{minted}[frame=single,linenos]{xml}
<build>
    <stages>
        <stage>
            <id>1</id>
            <name>one</name>
        </stage>
    </stages>
</build>
...
\end{minted}
\caption{Ukázka XML}
\label{listing:xml}
\end{listing}

\begin{listing}[ht]
\begin{minted}[frame=single,linenos]{yaml}
build:
    stages:
        one:
            id: 1
...
\end{minted}
\caption{Ukázka YAML}
\label{listing:yaml}
\end{listing}

\subsection{Struktura souboru}

Struktura souboru odpovídá průběhu integrace.
U úkolů (jobs) lze navíc definovat podmínku jejich spuštění (only), typ běhového klienta (runner), obraz běhového prostředí (image) a proměnné prostředí.
Proměnné prostředí jsou dostupné příkazům, tak i podmínce spuštění úkolu.
Mimo definovaných proměnných prostředí uživatelem přidává systém také proměnné s informacemi z SCM a další.
Speciálním případem příkazů jsou příkazy, které se vykonají, pokud úkol selže (after\_failure).
Vhodné jsou například pro výpis logovacích souborů.


% \begin{listing}[ht]
% \begin{minted}[frame=single,linenos]{yaml}
% piper-yml:
%   type: object
%   additionalProperties: false
%   properties:
%     stages:
%       type: array
%       items:
%         type: string
%     jobs:
%       type: object
%       additionalProperties:
%         type: object
%         properties:
%           stage:
%             type: string
%           only:
%             type: string
%           runner:
%             type: string
%           image:
%             type: string
%           env:
%             type: object
%             additionalProperties:
%               oneOf:
%                 - type: string
%                 - type: integer
%                 - type: boolean
%           commands:
%             type: array
%             items:
%               type: string
%           after_failure:
%             type: array
%             items:
%               type: string
%         required:
%           - stage
%           - image
%           - commands
%   required:
%     - stages
% \end{minted}
% \caption{Definice struktury souboru v JSON schema}
% \end{listing}
\chap Gitlab CI

\sec Konfigurace

Konfigurace projektů je řešena pomocí souboru {\tt.gitlab-ci.yml}, který je umístěn přímo v~kořenovém adresáři repozitáři projektu.

\sec Průběh integrace

Proces integrace je rozdělen na fáze ({\it stages}), úkoly ({\it jobs}) a příkazy.
Fáze se vykonávají sekvenčně za sebou v~zadaném pořadí.
Pokud jedna z~fází selže, tak celý proces integrace končí chybou.

\begtt
stages:
  - test
  - build
  - deploy
\endtt
\nobreak \label[gitlab:l:stages]
\caption/l Ukázka definice fází
\smallskip

\noindent
Jednotlivé fáze se skládají z~několika úkolů.
Ůkoly jsou spouštěny nezávisle na sobě a tím pádem je lze paralelizovat.
Selhání jednoho z~úkolů vede k~neuspěchu celé fáze.
Úkoly jsou vždy provedeny všechny, nezávisle na výsledku ostatních v~rámci fáze.

\begtt
job1:
  stage: test
  script:
    - cmd 1
    - cmd 2
\endtt
\nobreak \label[main]
\caption/l Definice úkolu s~názvem job1 v~rámci fáze test 
\smallskip

\noindent
Každý úkol je složen z~několika příkazů.
Pokud jeden z~příkazů skončí chybovým návratovým kódem, pak je ukončeno provádění úkolu.


Mezi speciální úkoly patří {\tt before\_script} a {\tt after\_script}.
Tyto úkoly jsou provedeny vždy před nebo po každým uživatelsky definovaným úkolem.

\begtt
before_script:
  - cmd 1
  - cmd 2

after_script:
  - cmd 1
  - cmd 2
\endtt
\nobreak \label[main]
\caption/l dasd
\smallskip

\noindent
Jednotlivým úkolům lze přiřadit podmínečné spuštění pomocí notace {\tt when}

\begitems
* {\tt on\_success} -- vykonej pouze pokud předchozí fáze skončila úspěchem (výchozí) 
* {\tt on\_failure} -- vykonej pouze pokud předchozí fáze skončila neúspěchem
* {\tt always} -- vykonej vždy
\enditems


\sec Běhová prostředí

CI systém spolupracuje s~několika běhovými servery ({\it Runners}), které se starají o~samotné vykonání definovaných příkazů (sestavení).
Běhové servery využívají exekutory.

% https://docs.gitlab.com/ee/ci/runners/README.html

\secc Gitlab CI multi-runner

Implementuje několik exekutorů.
Volba běhováho serveru je definována na úrovni konfigurace projektu a je omezena globálním nastavením Gitlab CI.

\seccc Shell

Příkazy provádí pod stejným uživatelem jako samotný běhový server.
Příkazy přeneseny jako soubor.

\seccc Docker

Docker je kontejnerová technologie.
Kontejnery jsou sestavovány z~Docker obrazů definující sadu dostupného softwaru.
Pro jednotlivá sestavení je vytvořena nová instance Docker kontejneru.
Volba obrazu pro sestavení a pro jednotlivé joby je definována klíčovým slovem {\tt image}.
Sestavení lze obohatit o~tzv. služby, kterými můžeme každému buildu dát k~dispozici přístup k~další Docker instanci, která bude dostupná pod zadanou hostname.
Služby lze opět konfigurovat na úrovni sestavení, tak na úrovni jobu.

\begtt
image: ruby:2.2

services:
  - postgres:9.3

test:
  script:
  - bundle exec rake spec
\endtt
\nobreak \label[main]
\caption/l Ukázka konfigurace obrazů
\smallskip

\seccc VirtualBox a Parallels

Virtualizační technologie.
Virtualní stroj musí podporovat Bash kompatibilní shell a být dostupný přes SSH spojení.
Virtualní stroje jsou klonovány pro udržení čistého prostředí pro sestavení a snapshotovány pro urychlení dalších sestavení.

% https://docs.gitlab.com/runner/executors/README.html

\seccc SSH

Podobné jako Shell exekutor, jen je využito SSH spojení.

\sec Cachování

Ve výchozím stavu je cache sdílena mezi {\it branch} a {\it job}.
Toto chování lze upravit nastavením klíče, který bude identifikovat danou cache.
Při tvorbě klíče lze využít předdefinované CI proměnné. 
Soubory a složky určené k~cachování uvedeme jako výčet v~konfiguraci projektu.
Cesta k~souboru je uvedená jako relativní ke kořeni projektu, cachování souborů mimo projekt není touto cestou možné. 
Cache lze také omezit pouze na soubory a složky, které nejsou verzovany GITem.
\cite[gitlab:cache]

\begtt
cache:
  key: "$CI_BUILD_NAME/$CI_BUILD_REF_NAME"
  untracked: true
  paths:
    - binaries/
    - .config
\endtt
\nobreak \label[main]
\caption/l Ukázka konfigurace cache
\smallskip
 
\noindent
Cache je ve výchozím nastavení ukládána přímo na běhovém serveru.
Pokud fáze běží na jiných běhových serverech, tak se cache nesdílí.
Alternativně můžeme použít sdílené cachování na S3 kompatibilních serverech.
S3 je REST API, které bylo původně vytvořeno jako část Amazon services.
Toto API implementuje samotný Amazon, tak i nějaké self-hosted projekty.

% https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/merge_requests/88
% https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html
% https://github.com/minio/minio/

\sec Perzistence dat


